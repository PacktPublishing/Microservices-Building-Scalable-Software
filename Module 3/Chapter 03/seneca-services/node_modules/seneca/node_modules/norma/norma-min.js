/* Copyright (c) 2014-2015 Richard Rodger, MIT License */
"use strict";function compile(e){if(null==e)throw error("no_spec","no argument specification");var r=specmap[e];if(null!=r)return r;var s=parse_spec(e),n=[],i=1,t=["^"],o=0;s.forEach(function(e){if(t.push("("),e.type.or&&0<e.type.or.length){var r=1;t.push("("),t.push(e.type.mark),t.push(")"),e.type.or.forEach(function(e){t.push("|"),t.push("("),t.push(e[1]),r++,t.push(")")}),"?"==e.mod&&t.push("|[UNA]?"),n[o]={index:i},i+=r}else"?"==e.mod?t.push("[UNA"+e.type.mark+"]?"):(t.push(e.type.mark),t.push(e.mod||"")),n[o]={index:i};n[o].mod=e.mod,t.push(")"),i++,o++}),t.push("$");var a=new RegExp(t.join(""));return r=specmap[e]={re:a,spec:e,respec:s,reindex:n}}function parse_spec(e){try{return parser.parse(e)}catch(r){throw error("parse",r.message+'; spec:"'+e+'", col:'+r.column+", line:"+r.line)}}function processargs(e,r,s){var n=Array.prototype.slice.call(s||[]),i=describe(n),t=e.re.exec(i);if(!t){if("throw"==r.onfail)throw error("invalid_arguments",'invalid arguments; expected: "'+e.spec+'", was: ['+i+"]; values: "+descargs(n,r),{args:n,specdef:e,options:r});return null}for(var o=e.respec.object?{}:[],a=0,p=0,u=0;a<e.reindex.length;a++){var c=e.reindex[a],l=void 0;if(e.respec.object||(o[u]=l),null!=c.index){var d=t[c.index],f=""!==d;if(f){var h=e.respec[a].name,m="*"===e.respec[a].mod,g="+"===e.respec[a].mod;if(0===d.length&&g)throw error("invalid_arguments",'invalid arguments; expected: "'+e.spec+'", was: ['+i+"]; values: "+descargs(n,r),{args:n,specdef:e,options:r});if(1==d.length)l=n[p],p++,e.respec.object||(o[u]=l),null!=h&&(m||g?(o[h]=o[h]||[]).push(l):o[e.respec[a].name]=l),u++;else if(1<d.length)for(var v=0;v<d.length;v++)l=n[p],p++,e.respec.object||(o[u]=l),null!=h&&(o[h]=o[h]||[]).push(l),u++}else e.respec.object||(o[u]=void 0),u++}}return o}function describe(e){var r=[];return e.forEach(function(e){r.push(_.isString(e)?"s":isNaN(e)||(0|e)!==parseFloat(e)?_.isNaN(e)?"A":1/0===e?"Y":_.isNumber(e)?"n":_.isBoolean(e)?"b":_.isFunction(e)?"f":_.isArray(e)?"a":_.isRegExp(e)?"r":_.isDate(e)?"d":_.isArguments(e)?"g":util.isError(e)?"e":_.isNull(e)?"N":_.isUndefined(e)?"U":_.isObject(e)?"o":"q":"i")}),r.join("")}function descargs(e,r){var s=[];return _.each(e,function(e){var n=util.inspect(e).substring(0,r.desclen);s.push(n)}),s}function handle(e,r,s){if((_.isArguments(r)||_.isArray(r))&&(s=r,r=null),r=null==r?defopts:_.extend({},defopts,r),null==s)throw error("init",'no arguments variable; expected norma( "...", arguments ), '+"or <compiled>( arguments )",{arguments:arguments});return processargs(e,r,s)}var util=require("util"),_=require("lodash"),error=require("eraro")({"package":"norma"}),parser=require("./norma-parser"),defopts={onfail:"throw",desclen:33},specmap={};module.exports=function(e,r,s){var n=compile(e);return handle(n,r,s)},module.exports.compile=function(e){var r=compile(e),s=function(e,s){return handle(r,e,s)};return s.toString=function(){return util.inspect({spec:r.spec,re:""+r.re})},s};
//# sourceMappingURL=norma-min.map